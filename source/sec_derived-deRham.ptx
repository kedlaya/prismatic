<section xml:id="sec_derived-deRham">
  <title>Derived de Rham cohomology</title>
  <introduction>
    <paragraphs>
      <title>Reference</title>
      <p>
        <xref ref="bib-Bhatt-course"/>, lecture VII.
      </p>
    </paragraphs>
    <p>
      In this section, we apply the formalism of nonabelian derived functors (<xref ref="sec_nonabelian-derived"/>) to the cohomology of differential forms,
      starting with the cotangent complex and then moving to derived de Rham cohomology.
      This will set up a paradigm of leveraging our knowledge about polynomial rings (or their completions) which will persist in the discussion of derived
      prismatic cohomology in <xref ref="sec_derived-prismatic"/>.
    </p>
  </introduction>
  <subsection xml:id="subsec_cotangent-complex">
    <title>The cotangent complex</title>
    <p>
      We illustrate the formalism with Illusie's construction of the <q>derived cotangent bundle</q> 
      <xref ref="bib-Illusie-cotangent1"/>, <xref ref="bib-Illusie-cotangent2"/>.
    </p>
    <definition>
      <p>
        For <m>A \in \Ring</m>, the <term>cotangent complex</term> is the functor <m>L_{\bullet/A}\colon \Ring_A \to D(A)</m> taking
        obtained by taking the left derived functor of the functor <m>\Poly_A \to D(A)</m> given by <m>B \mapsto \Omega^1_{B/A}[0]</m>.
        It is straightforward to check that in fact <m>L_{B/A} \in D^{\leq 0}(B)</m>.
      </p>
      <p>
        Note that it also makes sense to talk about <m>L_{B/A}</m> when <m>B</m> is itself a simplicial object in <m>\Ring_A</m>. This will be useful when
        stating the base change property in <xref ref="prop-cotangent-complex"/>.
      </p>
    </definition>
   <proposition xml:id="prop-cotangent-complex">
     <statement>
       <p>
         For <m>A \to B</m> a morphism in <m>\Ring</m>, the cotangent complex <m>L_{B/A} \in D(B)</m> has the following properties.
         (These also hold when <m>B</m> is a simplicial object in <m>\Ring_A</m>.)
       </p>
      <ol>
        <li>
          <p>
            We have a natural (in <m>B</m>) isomorphism <m>H^0(L_{B/A}) \cong \Omega^1_{B/A}</m>.
          </p>
        </li>
        <li>
          <p>
            If <m>A \to B</m> is smooth, then <m>L_{B/A} \cong \Omega^1_{B/A}[0]</m>. In particular, if <m>A \to B</m> is étale then
            <m>L_{B/A} \cong 0</m> (but not conversely; see for example <xref ref="exer-cotangent-complex-perfect"/>).
          </p>
        </li>
        <li>
          <p>
            For any morphisms <m>A \to B \to C</m>, we have a distinguished triangle in <m>D(C)</m>
            <men xml:id="eq-cotangent-complex-sequence">
              L_{B/A} \otimes^L_B C \to L_{C/A} \to L_{C/B} \to
            </men>.
            This extends the usual low-degree exact sequence for differentials.
          </p>
        </li>
        <li>
          <p>
            For any surjective morphism <m>A \to B</m> with kernel <m>I</m>, we have <m>H^{-1}(L_{B/A}) \cong I/I^2</m>. Moreover, if <m>I</m> is generated by a regular sequence,
            then <m>H^i(L_{B/A}) = 0</m> for <m>i \neq -1</m>. (This generalizes the assertion that a closed immersion of schemes is unramified.)
          </p>
        </li>
        <li>
          <p>
            For any morphisms <m>A \to B, A \to C</m>, we have a natural base change isomorphism
            <me>
              L_{C/A} \otimes_A^L B \cong L_{C \otimes_A^L B/B}
            </me>
            where <m>C \otimes_A^L B</m> is to be interpreted as a simplicial ring as per <xref ref="exa-derived-tensor-product"/>. 
            We can replace <m>C \otimes_A^L B</m> with <m>C \otimes_A B</m> if one of <m>A \to B</m>
            or <m>A \to C</m> is flat, or more generally if <m>A \to B</m> and <m>A \to C</m> are <term>Tor independent</term> (meaning that <m>\Tor_i^A(B,C) = 0</m> 
            for all <m>i \gt 0</m>).
          </p>
        </li>
      </ol>
      </statement>
      <proof>
        <p>
          See <xref ref="bib-Stacks"/>, tag 08P5.
        </p>
      </proof>
    </proposition>
    <p>
      The following is an analogue of the flatness of completion for noetherian rings, but without a noetherian hypothesis.
    </p>
    <lemma xml:id="lem-cotangent-complex-of-completion">
      <statement>
        <p>
         Let <m>A \in \Ring</m> be classically <m>p</m>-complete with bounded <m>p</m>-power torsion. Let <m>B \in \Ring_A</m> be flat (so that <m>B</m> also has bounded <m>p</m>-power torsion).
         Let <m>\widehat{B}</m> be the classical <m>p</m>-completion of <m>B</m>. 
         Then the derived <m>p</m>-completion of the cotangent complex of <m>B \to \widehat{B}</m> is zero
         in <m>D(\widehat{B})</m>.
        </p>
      </statement>
      <proof>
        <p>
          The complex in question vanishes after applying <m>\otimes_{\ZZ}^L \ZZ/p</m> by the base change formula (<xref ref="prop-cotangent-complex"/>), and then
          derived Nakayama (<xref ref="prop-derived-complete-abelian-derived"/>) yields the claim.
        </p>
      </proof>
    </lemma>
  </subsection>
  <subsection>
    <title>Derived de Rham cohomology</title>
    <p>
      We first prepare for the Hodge-Tate comparison by introducing derived de Rham cohomology, picking up the thread from our previous discussion of the cotangent complex
      (<xref ref="subsec_cotangent-complex"/>).
    </p>
    <definition xml:id="def-derived-de-Rham">
      <p>
        For <m>k \in \Ring_{\FF_p}</m>, the <term>derived de Rham cohomology</term> functor <m>\dR_{\bullet/k}\colon \Ring_k \to D(k)</m> is the left derived functor of
        the functor <m>\Poly_k \to D(k)</m> given by <m>R \mapsto \Omega^\bullet_{R/k}</m>.
      </p>
      <p>
        Let us unwind this for a given ring <m>R \in k</m>. Let <m>P_\bullet \to R</m> be the standard simplicial resolution of <m>R</m> (<xref ref="exa-standard-resolution-rings"/>)
        Then <m>\dR_{R/k}</m> is the totalization of the double complex <m>\Omega^\bullet_{P_\bullet/k}</m>. Note that this double complex is bounded below in one direction 
        (coming from the de Rham complex)
        and bounded above in the other (coming from the simplicial resolution),
        so we must handle this totalization with some care (see <xref ref="rmk-derham-comparison-char-0"/>).
      </p>
    </definition>
    <p>
      To state the derived analogue of the Cartier isomorphism, we need to explain what we mean by a <q>filtration</q> in a derived category. (This is also the correct
      context in which to construct the spectral sequence associated to a filtered complex, as arose in the proof of <xref ref="prop-spectral-sequence-double-complex"/>.)
    </p>
    <definition xml:id="def-filtered-derived-category">
      <p>
        For <m>k \in \Ring</m>, by an <term>increasing exhaustive filtration</term> of an object <m>K \in D(k)</m>, we will mean a sequence
        <m>\Fil_0 \to \Fil_1 \to \cdots</m> in <m>D(k)</m> with colimit <m>K</m>. The <term>associated graded quotients</term> are the mapping cones
        <m>\gr_i(\Fil_\bullet) = \Cone(\Fil_{i-1} \to \Fil_i)</m>.
      </p>
    </definition>
    <remark>
      <p>
        You might initially find it confusing that <xref ref="def-filtered-derived-category"/> does not specify that the maps <m>\Fil_i \to \Fil_{i+1}</m>
        are injections. The point is that this is not a meaningful concept in <m>D(k)</m>!
      </p>
    </remark>
    <p>
      Take note of the level of generality in the following proposition; there is no restriction on <m>R</m> at all!
    </p>
    <proposition xml:id="prop-derived-Cartier-isomorphism">
      <title>Derived Cartier isomorphism</title>
      <statement>
        <p>
          For <m>k \in \Ring_{\FF_p}</m> and <m>R \in \Ring_k</m>, there is a functorial (in <m>R</m>) increasing exhaustive filtration on <m>\dR_{R/k}</m> in <m>D(R^{(1)})</m>,
          called the <term>conjugate filtration</term>, equipped with canonical identifications 
          <me>
            \gr^i \dR_{R/k} \cong \left( \bigwedge^i L_{R^{(1)}/k} \right) [-i]
          </me>.
        </p>
      </statement>
      <proof>
        <p>
          For <m>R</m> a polynomial ring, we take the filtration on <m>\Omega^{\bullet}_{R/k}</m>
          where <m>\Fil_i</m> is the canonical truncation <m>\tau^{\leq i} \Omega^\bullet_{R/k}</m> (<xref ref="def-canonical-truncation"/>).
          The desired identifications in this case are just a reformulation of the Cartier isomorphism (<xref ref="lem-cartier-isomorphism-affine-space"/>).
          To deduce the general case, just take left derived functors.
        </p>
      </proof>
    </proposition>
    <remark>
      <p>
        The conjugate filtration derives its name from the fact that it goes in the opposite direction from the usual Hodge filtration;
        its relationship with the Cartier isomorphism seems to have been observed first by Katz <xref ref="bib-Katz-Turrittin"/>.
        The Hodge filtration and the conjugate filtration give rise to the usual <term>Hodge-de Rham spectral sequence</term>
        and the <term>conjugate spectral sequence</term>, respectively; the latter is unnamed in <xref ref="bib-Katz-Turrittin"/>, the modern terminology
        appearing first in <xref ref="bib-Lang"/>.
      </p>
    </remark>
    <p>
      Note that the following corollary is not automatic, because we don't currently have any way to control the effect of étale localization on derived
      de Rham cohomology; rather, we must prove this first and then deduce étale localization as a further corollary (<xref ref="cor-etale-localization-derived-deRham"/>).
    </p>
    <corollary xml:id="cor-compare-deRham-smooth">
      <statement>
        <p>
          For <m>k \in \Ring_{\FF_p}</m> and <m>R \in \Ring_k</m> smooth, there is a canonical isomorphism <m>\dR_{R/k} \cong \Omega^\bullet_{R/k}</m>
          which respects the conjugate filtrations on both sides.
        </p>
      </statement>
      <proof>
        <p>
          The map in question comes from the construction using the universal property of left Kan extensions.
          By <xref ref="prop-derived-Cartier-isomorphism"/>, it respects the conjugate filtration on both sides.
        </p>
        <p>
          The map on graded pieces can be written as <m>\left(\bigwedge^i L_{R^{(1)}/k} \right)[-i] \to \left(\Omega^i_{R^{(1)}/k} \right)[-i]</m> using <xref ref="prop-derived-Cartier-isomorphism"/>
          and the usual Cartier isomorphism
          (<xref ref="lem-cartier-isomorphism-affine-space"/> in the case of affine space; the general case follows by étale localization). 
          This map is an isomorphism for <m>i=1</m> by <xref ref="prop-cotangent-complex"/>, and hence is an isomorphism
          for general <m>i</m> as well.
        </p>
      </proof>
    </corollary>
    <corollary xml:id="cor-etale-localization-derived-deRham">
      <statement>
        <p>
          For <m>k \in \Ring_{\FF_p}</m> and <m>R \to S</m> an étale morphism in <m>\Ring_k</m>, there is a natural isomorphism <m>\dR_{R/k} \otimes_R^L S \cong \dR_{S/k}</m>.
        </p>
      </statement>
      <proof>
        <p>
          This formally reduces to the case where <m>R</m> is a polynomial ring in finitely many variables over <m>k</m>, in which case <m>S</m> is smooth over <m>k</m>
          and <xref ref="cor-compare-deRham-smooth"/> applies.
        </p>
      </proof>
    </corollary>
    <remark xml:id="rmk-derham-comparison-char-0">
      <p>
        Note that <xref ref="cor-compare-deRham-smooth"/> fails when <m>k</m> is not a ring of characteristic <m>p</m>.
        For example, if <m>k</m> is a <m>\QQ</m>-algebra, then <m>k \cong \Omega^*_{A/k}</m> by the Poincare lemma for any <m>A \in \Poly_k</m>, 
        so <m>k \cong \dR_{A/k}</m> for all <m>A \in \Ring_k</m>.
      </p>
      <p>
        What is going on here is that the definition of derived de Rham cohomology we are using is a shortcut taking advantage of the Cartier isomorphism. 
        The correct construction
        for general <m>k</m> requires an extra completion step that correctly accounts for the Hodge filtration, 
        plus some care for the difference between the <term>direct sum totalization</term> and the 
        <term>direct product totalization</term> of a double complex which is bounded above in one direction and bounded below in the other direction
        (see <xref ref="def-totalization"/>).
        See <xref ref="bib-Bhatt-course"/>, Lecture VII, Remark 3.8 for additional discussion and onward references.
      </p>
    </remark>
  </subsection>
  <subsection>
    <title>Regular semiperfect rings</title>
    <p>
      We next describe a large class of rings for which derived de Rham cohomology can be described explicitly. These can then be used in the terms of a simplicial resolution
      to compute derived de Rham cohomology more generally.
    </p>
    <definition xml:id="def-regular-semiperfect">
      <p>
        Let <m>k \in \Ring_{\FF_p}</m> be perfect. A <term>regular semiperfect</term> <m>k</m>-algebra is an object <m>S \in \Ring_k</m> of the form <m>R/I</m>
        where <m>R \in \Ring_{\FF_p}</m> is perfect and <m>I</m> is an ideal of <m>R</m> generated by a regular sequence. Note that any such ring is semiperfect,
        that is, the Frobenius map is surjective; this can be used to partially recover <m>R</m> from <m>S</m>, as per <xref ref="exer-perfection-of-regular-semiperfect"/>.
      </p>
    </definition>
    <example xml:id="exa-regular-semiperfect1">
      <p>
        A typical example of a regular semiperfect <m>k</m>-algebra is
        <me>
          S = k[x_1^{p^{-\infty}}, \dots, x_r^{p^{-\infty}}]/(x_1,\dots,x_r)
        </me>.
        Note that there are many ways to write <m>S</m> as <m>R/I</m>; for instance, we may take <m>R = k[x_1^{p^{-\infty}}, \dots, x_r^{p^{-\infty}}]</m>
        and <m>I = (x_1,\dots,x_r)</m>, but we can also replace <m>R</m> with its classical <m>I</m>-completion (or anything between). One can recover the completion
        from <m>S</m>; see <xref ref="exer-perfection-of-regular-semiperfect"/>.
      </p>
    </example>
    <lemma xml:id="lem-regular-semiperfect-de-Rham">
      <statement>
        <p>
          Let <m>k \in \Ring_{\FF_p}</m> be perfect and let <m>S \in \Ring_k</m> be regular semiperfect.
          Then <m>\dR_{S/k}</m> is concentrated in degree <m>0</m> (and thus can be viewed as an object in <m>\Ring_k</m>).
        </p>
      </statement>
      <proof>
        <p>
          Set notation as in <xref ref="def-regular-semiperfect"/>.
          By <xref ref="exer-cotangent-complex-perfect"/>, <m>L_{R/k}</m> vanishes in <m>D(R)</m>. From the distinguished triangle <xref ref="eq-cotangent-complex-sequence"/>
          associated to the morphisms <m>k \to R \to S</m>, we deduce that <m>L_{S/k} \to L_{S/R}</m> is an isomorphism in <m>D(S)</m>. Since <m>I</m> is generated by a
          regular sequence, <xref ref="prop-cotangent-complex"/> asserts that <m>L_{S/R} \cong I/I^2[1]</m> where <m>I/I^2</m> is a finite projective <m>S</m>-module.
          Consequently, the derived exterior power 
          <me>
            \bigwedge^i_S (L_{S/R}[-1]) = \left(\bigwedge^i_S L_{S/R} \right)[-i]
          </me> 
          is also concentrated in degree 0.
          By <xref ref="prop-derived-Cartier-isomorphism"/>, we may now deduce the claim.
        </p>
      </proof>
    </lemma>
    <example xml:id="exa-regular-semiperfect2">
      <p>
        In <xref ref="exa-regular-semiperfect1"/>, one may compute that
        <me>
          \dR_{S/k} \cong \bigoplus_{i_1,\dots,i_r \in \ZZ[p^{-1}]_{\geq 0}} k \cdot \frac{x_1^{i_1} \cdots x_r^{i_r}}{\lfloor i_1 \rfloor! \cdots \lfloor i_r \rfloor!}.
        </me>
        In general, we get the divided power envelope of <m>I</m> in <m>R</m> (in the sense of <xref ref="bib-Berthelot-Ogus"/>; we cannot apply 
        <xref ref="def-divided-power-envelope"/> as we are not in the <m>\ZZ_p</m>-flat case).
      </p>
    </example>
      <p>
        As an illustration of the technique we have in mind, let us apply this logic to ordinary de Rham cohomology in the smooth case.
      </p>
    <lemma xml:id="lem-derived-de-Rham-computation">
      <statement>
        <p>
          Let <m>k \in \Ring_{\FF_p}</m> be perfect and let <m>R \in \Ring_k</m> be smooth over <m>k</m>.
          Let <m>S</m> be the coperfection of <m>R</m>. 
          Let <m>S^\bullet</m> be the Čech nerve of <m>R \to S</m>.
        </p>
        <ol>
          <li>
            <p>
              The map <m>R \to S</m> is flat.
            </p>
          </li>
          <li>
            <p>
              For each <m>n \geq 0</m>, the ring <m>S^n</m> is regular semiperfect.
            </p>
          </li>
        </ol>
      </statement>
      <proof>
        <p>
          Since <m>R</m> is a smooth <m>k</m>-algebra and <m>k</m> is perfect, the Frobenius map <m>\phi_R\colon R \to R</m>
          is flat (see <xref ref="rmk-kunz"/>). It follows that <m>R \to S</m> is flat.
        </p>
        <p>
          To see that <m>S^n</m> is regular semiperfect, we may work étale locally to reduce to the case where <m>R = k[x_1,\dots,x_r]</m>.
          In this case, we may write
          <me>
            S^n = k[x_{ij}^{p^{-\infty}}\colon i=1,\dots,r; j=0,\dots,n]/(x_{ij} - x_{ij'}\colon i=1,\dots,r; 1 \leq j \lt j' \leq n)
          </me>
          to see that it is regular semiperfect.
        </p>
      </proof>
    </lemma>
    <remark xml:id="rmk-de-Rham-via-derived">
      <p>
        With notation as in <xref ref="lem-derived-de-Rham-computation"/>, <xref ref="cor-compare-deRham-smooth"/> implies that we can identify <m>\Omega^\bullet_{R/k}</m>
        with <m>\dR_{R/k}</m> in <m>D(k)</m>.
        For each <m>n</m>, <m>\dR_{S^n/k}</m> is concentrated in degree 0 by <xref ref="lem-regular-semiperfect-de-Rham"/>.
        It can be shown further that the functor <m>\dR_{\bullet/k}</m> satisfies descent with respect to the fpqc cover <m>R \to S</m>
        (see for instance  <xref ref="bib-Bhatt-Morrow-Scholze2"/>, section 3); consequently, <m>\dR_{R/k}</m> can be computed by the complex <m>\dR_{S^\bullet/k}</m>.
      </p>
    </remark>
  </subsection>
  <subsection>
    <title>Derived crystalline cohomology</title>
    <definition>
      <title>Derived crystalline cohomology</title>
      <p>
        Let <m>k \in \Ring_{\FF_p}</m> be perfect and let <m>A \in \Ring</m> be a classically <m>p</m>-complete ring with <m>A/p \cong k</m>.
        We wish to derive a <term>crystalline cohomology</term> functor <m>R\Gamma_{\crys}\colon \Poly_k \to D(A)</m> taking <m>R = k[x_1,\dots,x_r]</m>
        to <m>\widehat{\Omega}^{\bullet}_{P/A}</m> for <m>P = A[x_1,\dots,x_r]</m>; however, we need to make sure that this construction does not depend on the choice
        of coordinates on <m>R</m>. Fortunately, we can deduce this from our proof of the Hodge-Tate comparison, which gives us a canonical isomorphism
        of <m>\widehat{\Omega}^{\bullet}_{P/A}</m> with <m>\phi_A^* \Prism_{R/k}</m> (<xref ref="cor-prismatic-to-crystalline"/>).
      </p>
      <p>
        We define the <term>derived crystalline cohomology</term> functor <m>R\Gamma_{\dcrys}\colon \Ring_k \to D(A)</m> by taking the left derived functor of the
        ordinary crystalline cohomology <m>R\Gamma_{\crys}</m>. From the comparison of crystalline cohomology with de Rham cohomology 
        (<xref ref="prop-crystalline-cohomology-affine-space"/>), we obtain a natural isomorphism 
        <me>
          R\Gamma_{\dcrys}(\bullet/A) \otimes_A^L k \cong \dR_{\bullet/k}
        </me>.
      </p>
    </definition>
    <remark>
      <p>
        Using <xref ref="lem-derived-de-Rham-computation"/>, we can carry out the analogue of <xref ref="rmk-de-Rham-via-derived"/> to construct an explicit
        <em>functorial</em> complex computing the (derived) crystalline cohomology of a smooth algebra over a perfect ring.
        We omit the details here.
      </p>
    </remark>
  </subsection>
  <exercises>
    <exercise xml:id="exer-cotangent-complex-perfect">
      <statement>
        <p>
          Let <m>A \to B</m> be a morphism of perfect <m>\FF_p</m>-algebras. Show that <m>L_{A/B} \cong 0</m>.
        </p>
      </statement>
      <hint>
        <p>
          On one hand, <m>\phi_B</m> evidently induces an isomorphism on <m>L_{A/B}</m>.
          On the other hand, the induced map is zero when <m>B</m> is a polynomial ring over <m>A</m>.
        </p>
      </hint>
    </exercise>
    <exercise xml:id="exer-finite-presentation-perfect">
      <statement>
        <p>
          Let <m>f\colon A \to B</m> be a morphism of finite presentation between perfect <m>\FF_p</m>-algebras. Show that <m>f</m> is étale.
        </p>
      </statement>
      <hint>
        <p>
          Apply <xref ref="exer-cotangent-complex-perfect"/>.
        </p>
      </hint>
    </exercise>
    <exercise xml:id="exer-regular-semiperfect-is-perfect">
      <statement>
        <p>
          Let <m>R</m> be a perfect <m>\FF_p</m>-algebra and let <m>x_1,\dots,x_r \in R</m> be a regular sequence. Prove that the regular semiperfect ring
          <m>S = R/(x_1,\dots,x_r)</m> is perfect if and only if <m>S</m> is a direct factor of <m>R</m>.
        </p>
      </statement>
      <hint>
        <p>
          By <xref ref="exer-finite-presentation-perfect"/>, the map <m>R \to S</m> is both étale and surjective, and hence a closed-open immersion.
        </p>
      </hint>
    </exercise>
    <exercise xml:id="exer-cotangent-complex-lens">
      <statement>
        <p>
          Let <m>A \to B</m> be a morphism of lenses. Using <xref ref="exer-cotangent-complex-perfect"/>, show that the derived <m>p</m>-completion of <m>L_{B/A}</m> vanishes.
        </p>
      </statement>
      <hint>
        <p>
          As in <xref ref="lem-cotangent-complex-of-completion"/>, use derived Nakayama to reduce to <xref ref="prop-derived-complete-abelian-derived"/>.
          See also <xref ref="bib-Bhatt-Scholze"/>, Lemma 3.14.
        </p>
      </hint>
    </exercise>
    <exercise xml:id="exer-perfection-of-regular-semiperfect">
      <statement>
        <p>
          With notation as in <xref ref="def-regular-semiperfect"/>, show that the perfection of <m>S</m> is canonically isomorphic to the classical <m>I</m>-completion of <m>R</m>.
        </p>
      </statement>
    </exercise>
  </exercises>
</section>